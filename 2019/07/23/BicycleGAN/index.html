<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="zhihuaT">





<title>BicycleGAN论文 | zhihuaT</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
            <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


        
    


<meta name="generator" content="Hexo 4.2.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">zhihuaT</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">zhihuaT</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">BicycleGAN论文</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">zhihuaT</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">July 23, 2019&nbsp;&nbsp;12:41:10</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>最近看了关于 <strong>BicycleGAN</strong> 的一篇论文，在此将自己看论文的收获记录于此。因为阅读该篇论文是算本人的一个任务，所以看的比较详细，下面写的也非常详细，基本上是按照论文的逻辑写下来的。如果仅仅是想大致了解什么是<strong>BicycleGAN</strong>，可以看其他人的介绍，我的博客中仅看最后一部分即可，是我研究代码后得出的网络结构。</p>
<a id="more"></a>
<p>最近看过一篇论文<a href="https://arxiv.org/pdf/1711.11586.pdf" target="_blank" rel="noopener">Toward multimodal Image-to-Image translation</a>，讲述的主要是关于 <strong>BicycleGAN</strong> 的生成式对抗网络模型。在网上也看到过一些相关的博客，但讲得不算深入。因此在此将自己看论文的收获记录于此。</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>一般的生成式对抗网络，为单模态的。也就是给你一个真实的图片(ground truth)，网络的任务是生成与该图片非常接近的图片，不管是在颜色上，形状上还是其他方面。 而 <strong>BicycleGAN</strong> 的不同之处在于，该网络生成的图片不求与原图片完全相同，但求在生成的图像判断为真实图像的情况下，可以与原图像有风格上的差异。如果以环境图像为例的话可以参看下图<br><img src="/BicycleGAN论文/Figure1.png" alt="Figure1"><br>其中，真实的图像为一个夜景。而我们的目的是生成与该场景对应的白天的图像。我们要求白天的图像是多元的，但同时要求它看上去是真实的。</p>
<blockquote>
<p>我们可以自己先考虑一下，如何才能让最后的输出变得多元？那就是在对生成器输入的时候加入噪声。那么应该怎么加噪声，以及应该加什么样的噪声呢，可以继续往下看。</p>
</blockquote>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>首先从 <a href="https://arxiv.org/pdf/1611.07004v1.pdf" target="_blank" rel="noopener"><strong>pix2pix框架</strong> </a>谈起。<strong>pix2pix框架</strong> 已经证明可以为图像到图像的转换提供高质量的结果，但它只能输出单一的图像。并且即使在输入时添加随机噪声，仍得不到多元的输出结果。因此作者提出，在输出和潜在空间之间建立一种<a href="https://baike.baidu.com/item/%E5%8F%8C%E5%B0%84/942799?fr=aladdin" target="_blank" rel="noopener">双射</a>，使网络既能够执行潜在空间（和输入）映射到输出的任务，同时还学习从输出回到潜在空间的编码器。这样使得不同的随机噪声不会产生相同的输出。</p>
<p> 作者从以下两个无条件生成模型出发，对模型进行改进</p>
<ul>
<li><strong>cVAE-GAN (Conditional Variational Autoencoder GAN): </strong> 一个方法是先将真实图像(Groud truth) 利用编码器映射到潜在空间，得到一个条件噪声 $Q(z|B)$。然后将其和输入图像一起送入到生成器中进行训练，得到输出图像。为了确保  $Q(z|B)$  的随机性，我们利用<a href="https://www.cnblogs.com/nlpowen/p/3620470.html" target="_blank" rel="noopener">KL距离</a>来将其与正态分布进行比较，计算其损失。</li>
<li><strong>cLR-GAN (Conditional Latent Regressor GAN): </strong> 另一个方法先提供一个随机的潜在向量，将其与输入图像一起送入生成器，得到生成图像。然后利用一个编码器将生成图像恢复为初始的随机向量。这个生成的向量和一开始随机的潜在向量之间存在一个损失。</li>
<li><strong>BicycleGAN: </strong> 将以上两个模型结合得到我们的模型。（真的是直接框起来了……，结合起来后变成一个什么网络结构也没画出来。当时看的要吐血。但研究代码后，我终于弄清楚了，在后面给出。先给原论文中的图）<br><img src="/BicycleGAN论文/Figure2.png" alt="Figure2"></li>
</ul>
<h3 id="多模态图像到图像的转换"><a href="#多模态图像到图像的转换" class="headerlink" title="多模态图像到图像的转换"></a>多模态图像到图像的转换</h3><p>我们的目标是在两个数据域之间学习一个多模态的映射。考虑输入域 $\mathcal{A} \subset \mathbb{R}^{H \times W  \times 3}$ ，它被映射到输出域 $\mathcal{B} \subset \mathbb{R}^{H \times W  \times 3}$ 。在训练过程中，我们的数据集是来自这两个数域的成对的数据,  $\left{ A \subset \mathcal{A}, B \subset\mathcal{B} \right}$ 。事实上，对于输入 $A$ ，可能有很多实例 $B$ 与其对应，但我们的训练数据集仅包含这样的一对数据。而我们的模型，是为了在输入一个新的实例 $A$ 的情况下，可以生成一个 $\hat{\mathcal{B}}$ ,其中包含多个可能的 $\hat{B}$ ，分别对应着不同的 $p(B|A)$ 。</p>
<p>虽然条件生成式对抗网络$(CGANs$) 在图像-图像转换任务取得了成功，但对入输入图像$A$，它受限于仅生成单个（确定）的图像 $\hat{B}$。在前面我们提到，我们先学习一个低维的潜在空间$z\in\mathbb{R}^Z$,它包含了输出模式中一些非常模糊的方面，像$Figure1$中的云层，光线等等，这些在输入图像中并不能直接体现出来。因此我们便可以将一张夜景的图像映射为具有不同云层，不同光线的图像。然后我们再学习一个确定性的映射$G:(A,z)\to B$,为了实现随机抽样，我们希望从先验分布$p(z)$中抽取潜在向量$z$,在这个过程中，使用标准正态分布$\mathscr{N}(0,I)$。</p>
<h4 id="1-Baseline-pix2pix-noise-z-to-hat-B"><a href="#1-Baseline-pix2pix-noise-z-to-hat-B" class="headerlink" title="1.Baseline: pix2pix+noise($z\to\hat{B}$)"></a>1.Baseline: pix2pix+noise($z\to\hat{B}$)</h4><p>对抗性损失如下：</p>
<script type="math/tex; mode=display">
\mathcal{L}_{GAN}(G,D)=\mathbb{E}_{A,B\sim p(A,B)}[log(D(A,B))]+\mathbb{E}_{A\sim p(A),z\sim p(z)}[log(1-D(G(A,z)))] 
\tag{1}</script><p>为了使得输出 $\hat{B}$ 更加契合原始图像$B$,同时增强模型的稳定性，在输出图像和原始图像之间定义$\mathcal{l_1}$损失。</p>
<script type="math/tex; mode=display">
\mathcal{L_1^{image}}(G)=\mathbb{E_{A,B\sim p(A,B)}}||B-G(A,z)||_1 \tag{2}</script><p>总的损失函数为：</p>
<script type="math/tex; mode=display">
G^*=arg \ min_G\  max_D\   \ {\mathcal L_{GAN}(G,D)+\lambda \mathcal{L_1^{image}}(G)} \tag{3}</script><p>然而这种方法并不合适，在 <strong>pix2pix</strong> 的原论文中作者也提到，生成器会忽略添加的噪声noise，因此最终将其在实验中删除。</p>
<h4 id="2-Conditional-Variational-Autoencoder-GAN-cVAE-GAN-hat-B-to-z-to-hat-B"><a href="#2-Conditional-Variational-Autoencoder-GAN-cVAE-GAN-hat-B-to-z-to-hat-B" class="headerlink" title="2.Conditional Variational Autoencoder GAN: cVAE-GAN($\hat{B}\to z\to\hat{B}$)"></a>2.Conditional Variational Autoencoder GAN: cVAE-GAN($\hat{B}\to z\to\hat{B}$)</h4><p>让低维向量<script type="math/tex">z</script>强制对生成多元化的输出图像产生作用的方法是利用编码器<script type="math/tex">E</script>得到 $Q(z|B)$ 。这样，生成器<script type="math/tex">G</script>就可以同时利用低维向量<script type="math/tex">z</script>和输入图像<script type="math/tex">A</script>来合成输出图像<script type="math/tex">\hat{B}</script>。此过程可以在Figure2(c)很好的展示出来。（相较于<strong>VAE-GAN</strong>，输入图像$A$为condition）</p>
<p>这种方法在无条件的变分自动编码器中取得了成功。将其应用到条件变分自动编码器时，我们可以假设$Q(z|B)$ 满足高斯分布$\mathscr{N}(0,I)$,因此$Q(z|B)\overset{\bigtriangleup}{= }E(B)$。为了反映这一点，公式$(1)$改为对$z\sim E(B)$进行采样，允许其进行发现传播。</p>
<script type="math/tex; mode=display">
\mathcal{L}^{VAE}_{GAN}=\mathbb{E}_{A,B\sim p(A,B)}[log(D(A,B))]+\mathbb{E}_{A,B\sim p(A,B),z\sim E(B)}[log(1-(D(A,G(A,z))))]\tag{4}</script><p>我们对公式$(2)$中的$\mathcal{l<em>1}$损失进行变化，得到$\mathcal{L}_1^{VAE}(G)=\mathbb{E</em>{A,B\sim p(A,B),z\sim p(z)}}||B-G(A,z)||_1 $。此外，当$B$未知时，我们鼓励$E(B)$更加趋近于高斯分布。</p>
<script type="math/tex; mode=display">
\mathcal{L}_{KL}(E)=\mathbb{E}_{B\sim p{B}}[\mathcal{D}_{KL}(E(B)|| \mathcal{N}(0,I)]  \tag{5}</script><p>因此我们有条件的<strong>VAE-GAN</strong>其模型可写为：</p>
<script type="math/tex; mode=display">
G^*,E^*=arg \ min_{G,E}\  max_D\   \ \mathcal {L}^{VAE}_{GAN}(G,D,E)+\lambda \mathcal{L}_1^{VAE}(G) +\lambda_{KL} \mathcal{L}_{KL}(E)\tag{6}</script><p>作为基准，文章还考虑该方法的确定性版本。即，丢弃$KL$距离并编码$z = E(B)$。 该方法称为cAE-GAN。在实验中比较显示， cAE-GAN无法保证潜在空间$z$的分布，使得$z$的测试时间采样变得困难。</p>
<h4 id="3-Conditional-Latent-Regressor-GAN-cLR-GAN-z-to-hat-B-to-hat-z"><a href="#3-Conditional-Latent-Regressor-GAN-cLR-GAN-z-to-hat-B-to-hat-z" class="headerlink" title="3.Conditional Latent Regressor GAN: cLR-GAN($z\to \hat{B} \to \hat{z}$)"></a>3.Conditional Latent Regressor GAN: cLR-GAN($z\to \hat{B} \to \hat{z}$)</h4><p>文章还探索了另一种强制生成器利用低维向量$z$的方法。像在$Figure2(c)$中展示的那样。我们从随机向量$z$作为输入开始，并且尝试利用公式$\hat{z}=E(G(A,z))$在最后恢复它。值得注意的是这里生成的$\hat{z}$为点估计，而上部分向量$\hat{z}$预测为高斯分布。</p>
<script type="math/tex; mode=display">
\mathcal{L_1^{latent}}(G,E)=\mathbb{E}_{A\sim p(A),z\sim p(z)}||z-E(G(A,z))||_1 \tag{7}</script><p>和公式$(1)$一样，我们同样有$\mathcal{L}_{GAN}$损失使网络生成更加真实的结果。整个网络的损失可以写为：</p>
<script type="math/tex; mode=display">
G^*,E^*=arg \ min_{G,E}\  max_D\   \ {\mathcal L_{GAN}(G,D )+\lambda_{latent} \mathcal{L_1^{latent}}(G,E)} \tag{8}</script><p>在该模型中，并没有在真实图像$B$和输出图像$\hat{B}$之间计算其$\mathcal{l}_1$损失。因为我们不要求这两者之间完全一样，但要求$\hat{B}$必须看上去是真实的。（基于这个原因，为什么上个模型需要$\hat{l}_1$损失我也搞不清楚……）</p>
<h4 id="4-OurHybridModel-BicycleGAN"><a href="#4-OurHybridModel-BicycleGAN" class="headerlink" title="4.OurHybridModel: BicycleGAN"></a>4.OurHybridModel: BicycleGAN</h4><p>将<strong>cVAE-GAN</strong>和<strong>cLR-GAN</strong>组合为混合模型，得到我们的模型<strong>BicycleGAN</strong>。对于<strong>cVAE-GAN</strong>，网络是从实际数据中学习的，但随机向量$z$在测试时可能无法产生逼真的图像—$KL$损失可能无法很好地优化。 更重要的是，判别器$D$在训练期间得不到前面采样的信息（因为$Q(z|B)$是先验分布，而不是随机抽样得来的）。在<strong>cLR-GAN</strong>中，随机向量$z$很容易从简单的分布中采样，但是生成器在训练过程中没有得到真实图像的输入对其的优化（可对比cVAE-GAN来看）。将这两个模型结合起来，可以同时具备这两个循环（$\hat{B}\to z\to\hat{B}$， $z\to \hat{B} \to \hat{z}$）的优势。总的损失为：</p>
<script type="math/tex; mode=display">
G^*,E^*=arg \ min_{G,E}\  max_D\  \  \mathcal{ L}^{VAE}_{GAN}(G,D,E)+\lambda\mathcal{L}_1^{VAE}(G) +\mathcal L_{GAN}(G,D )+\lambda_{latent} \mathcal{L}_1^{latent}(G,E) +\lambda_{KL} \mathcal{L}_{KL}(E)\tag{9}</script><p>论文的内容到此就结束了。接下来主要是我研究代码后学到的一些内容。因为论文中具体的网络结构并不清楚，在看完代码后才理清了思路。并且利用TensorFlow画出来graph来。(GitHub上论文的<a href="https://github.com/gitlimlab/BicycleGAN-Tensorflow" target="_blank" rel="noopener">TensorFlow版本代码</a>，原作为<a href="https://github.com/junyanz/BicycleGAN" target="_blank" rel="noopener">PyTorch版本</a>)</p>
<p>我自己看PyTorch版本代码画出的结构图（尽力了，呼……）<br><img src="/BicycleGAN/net.png" alt="net"></p>
<p>利用Tensorboard画的graph<br><img src="/BicycleGAN/graph.png" alt="graph"></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>zhihuaT</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://yoursite.com/2019/07/23/BicycleGAN/">http://yoursite.com/2019/07/23/BicycleGAN/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"># 深度学习</a>
                    
                        <a href="/tags/%E7%94%9F%E6%88%90%E5%BC%8F%E5%AF%B9%E6%8A%97%E7%BD%91%E7%BB%9C/"># 生成式对抗网络</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2019/07/25/InfoGAN/">InfoGAN论文</a>
            
            
            <a class="next" rel="next" href="/2019/07/23/my%20first%20blog/">My first blog!!!</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© zhihuaT | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
